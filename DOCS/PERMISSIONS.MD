# ğŸ” **SISTEMA DE PERMISSÃ•ES - GUIA COMPLETO**

## ğŸš€ **COMO UM USUÃRIO NOVO GANHA PERMISSÃ•ES**

### **1. CriaÃ§Ã£o do UsuÃ¡rio (SEM PERMISSÃ•ES)**

```http
POST /users/
Content-Type: application/json

{
    "username": "novo_funcionario",
    "display_name": "JoÃ£o Silva", 
    "email": "joao@empresa.com",
    "password": "senha123"
}
```

**âš ï¸ IMPORTANTE**: Este endpoint **NÃƒO requer autenticaÃ§Ã£o** e **NÃƒO atribui permissÃµes**. O usuÃ¡rio fica completamente **sem acesso** ao sistema.

### **2. AtribuiÃ§Ã£o de Role via Assignment**

Para dar permissÃµes, um **administrador** deve criar um Assignment:

```http
POST /assignment/
Authorization: Bearer <token_admin>
Content-Type: application/json

{
    "user_id": 123,
    "role_id": 2
}
```

**Quem pode fazer?** Apenas usuÃ¡rios com permissÃ£o `OP_1010001` (Assignment - Create).

### **3. Cadeia de PermissÃµes (RBAC)**

```
ğŸ‘¤ User â†’ ğŸ”— Assignment â†’ ğŸ‘¥ Role â†’ âœ… Authorization â†’ ğŸ”§ Transaction
   JoÃ£o   â†’   vincula   â†’ Admin â†’   autoriza    â†’ Criar UsuÃ¡rio
```

**ValidaÃ§Ã£o**: A funÃ§Ã£o `validate_transaction_access()` verifica esta cadeia completa antes de permitir qualquer operaÃ§Ã£o.

## ğŸ†• **COMO CRIAR NOVAS PERMISSÃ•ES**

### **1. Definir CÃ³digo de OperaÃ§Ã£o**

Primeiro, adicione no enum de cÃ³digos:

```python
# app/api/transaction/enum_operation_code.py
class EnumOperationCode(Enum):
    # ... cÃ³digos existentes ...
    
    # --------------------- Nova Funcionalidade ---------------------
    OP_5000001 = '5000001'  # RelatÃ³rios - Gerar
    OP_5000002 = '5000002'  # RelatÃ³rios - Visualizar  
    OP_5000003 = '5000003'  # RelatÃ³rios - Excluir
```

### **2. Criar Nova Transaction**

```http
POST /transaction/
Authorization: Bearer <token_admin>
Content-Type: application/json

{
    "name": "RelatÃ³rios - Gerar",
    "description": "Gerar relatÃ³rios financeiros do sistema",
    "operation_code": "5000001"
}
```

**Quem pode fazer?** Apenas usuÃ¡rios com permissÃ£o `OP_1030001` (Transaction - Create).

### **3. Autorizar Roles para a Nova Transaction**

```http
POST /authorization/
Authorization: Bearer <token_admin>
Content-Type: application/json

{
    "role_id": 2,        # Role "Gerente"  
    "transaction_id": 456 # Transaction "RelatÃ³rios - Gerar"
}
```

**Quem pode fazer?** Apenas usuÃ¡rios com permissÃ£o `OP_1020001` (Authorization - Create).

### **4. Implementar ValidaÃ§Ã£o no Endpoint**

```python
@router.post('/relatorios/gerar')
def gerar_relatorio_financeiro(
    db_session: SessionDep,
    current_user: CurrentUser,
):
    # âœ… Validar permissÃ£o antes de executar
    validate_transaction_access(db_session, current_user, '5000001')
    
    # ğŸ”§ LÃ³gica do relatÃ³rio aqui...
    return {"message": "RelatÃ³rio gerado com sucesso"}
```

## ğŸ“Š **ESTRUTURA HIERÃRQUICA TÃPICA**

```
ğŸ”¥ SUPER ADMIN (todas as permissÃµes)
â”œâ”€â”€ ğŸ‘¨â€ğŸ’¼ ADMIN (gerenciar usuÃ¡rios, roles, autorizaÃ§Ãµes)  
â”œâ”€â”€ ğŸ“ˆ GERENTE (operaÃ§Ãµes de negÃ³cio, relatÃ³rios)
â”œâ”€â”€ âš™ï¸ OPERADOR (operaÃ§Ãµes bÃ¡sicas do dia-a-dia)
â””â”€â”€ ğŸ‘ï¸ VISITANTE (apenas consultas/leitura)
```

## ğŸ” **CONSULTAR PERMISSÃ•ES DE UM USUÃRIO**

```http
GET /users/{user_id}/transactions
Authorization: Bearer <token_admin>
```

**Quem pode fazer?** Apenas usuÃ¡rios com permissÃ£o `OP_1040006` (User - Transactions granted).

**Retorna**: Lista de todas as transactions/operaÃ§Ãµes que o usuÃ¡rio pode executar.

## ğŸ“‹ **CENÃRIOS PRÃTICOS COMPLETOS**

### **CenÃ¡rio 1: Novo FuncionÃ¡rio (Operador)**

```bash
# 1. Admin cria o usuÃ¡rio (sem permissÃµes)
curl -X POST /users/ \
  -H "Content-Type: application/json" \
  -d '{"username":"maria","display_name":"Maria Santos","email":"maria@empresa.com","password":"senha123"}'

# 2. Admin atribui role "Operador" (ID 3)
curl -X POST /assignment/ \
  -H "Authorization: Bearer <admin_token>" \
  -H "Content-Type: application/json" \  
  -d '{"user_id":123,"role_id":3}'

# 3. Maria agora pode fazer operaÃ§Ãµes bÃ¡sicas definidas no role "Operador"
```

### **CenÃ¡rio 2: PromoÃ§Ã£o para Gerente**

```bash
# 1. Admin remove assignment atual
curl -X DELETE /assignment/456 \
  -H "Authorization: Bearer <admin_token>"

# 2. Admin cria novo assignment com role "Gerente"  
curl -X POST /assignment/ \
  -H "Authorization: Bearer <admin_token>" \
  -H "Content-Type: application/json" \
  -d '{"user_id":123,"role_id":2}'
```

### **CenÃ¡rio 3: Nova Funcionalidade - Backup do Sistema**

```bash
# 1. Admin cria nova transaction
curl -X POST /transaction/ \
  -H "Authorization: Bearer <admin_token>" \
  -H "Content-Type: application/json" \
  -d '{"name":"Backup - Executar","description":"Executar backup do banco de dados","operation_code":"6000001"}'

# 2. Admin autoriza role "TI" para fazer backup
curl -X POST /authorization/ \
  -H "Authorization: Bearer <admin_token>" \
  -H "Content-Type: application/json" \
  -d '{"role_id":4,"transaction_id":789}'

# 3. Todos os usuÃ¡rios com role "TI" agora podem executar backup
```

## ğŸ›¡ï¸ **SISTEMA DE SEGURANÃ‡A**

### **ValidaÃ§Ãµes AutomÃ¡ticas**
- âœ… Todos os endpoints (exceto criaÃ§Ã£o de usuÃ¡rio) exigem autenticaÃ§Ã£o JWT
- âœ… Cada operaÃ§Ã£o valida se o usuÃ¡rio tem a permissÃ£o especÃ­fica
- âœ… Sistema previne escalaÃ§Ã£o de privilÃ©gios nÃ£o autorizada
- âœ… Auditoria completa com IP e usuÃ¡rio em todas as operaÃ§Ãµes

### **ExceÃ§Ãµes de SeguranÃ§a**
- ğŸš« `IllegalAccessException` - UsuÃ¡rio nÃ£o tem permissÃ£o
- ğŸš« `AmbiguousAuthorizationException` - MÃºltiplas autorizaÃ§Ãµes conflitantes  
- ğŸš« `CredentialsValidationException` - Token invÃ¡lido/expirado

## ğŸ¯ **FLUXO RESUMIDO DE UM NOVO USUÃRIO**

```mermaid
graph TD
    A[Admin cria usuÃ¡rio] --> B[UsuÃ¡rio SEM acesso]
    B --> C[Admin cria Assignment]
    C --> D[UsuÃ¡rio vinculado ao Role]
    D --> E[Role tem Authorizations]
    E --> F[UsuÃ¡rio pode executar Transactions]
    F --> G[Sistema valida a cada request]
```

- **Users** recebem **Roles** via **Assignments**
- **Roles** tÃªm permissÃµes via **Authorizations** para **Transactions** especÃ­ficas  
- Cada endpoint valida a cadeia completa antes de permitir a operaÃ§Ã£o
- Auditoria total de quem fez o que, quando e de onde 
